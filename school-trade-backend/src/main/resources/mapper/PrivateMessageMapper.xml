<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shanzhu.st.mapper.PrivateMessageMapper">
    <resultMap id="BaseResultMap" type="com.shanzhu.st.entity.PrivateMessage">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="sender_id" jdbcType="BIGINT" property="senderId"/>
        <result column="receiver_id" jdbcType="BIGINT" property="receiverId"/>
        <result column="content" jdbcType="VARCHAR" property="content"/>
        <result column="send_time" jdbcType="TIMESTAMP" property="sendTime"/>
        <result column="is_read" jdbcType="BIT" property="isRead"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, sender_id, receiver_id, content, send_time, is_read
    </sql>

    <insert id="insert" keyColumn="id" keyProperty="id"
            parameterType="com.shanzhu.st.entity.PrivateMessage" useGeneratedKeys="true">
        insert into private_message (sender_id, receiver_id, content, send_time, is_read)
        values (#{senderId}, #{receiverId}, #{content}, #{sendTime}, #{isRead})
    </insert>

    <select id="getMessageRecords" resultMap="BaseResultMap">
        select <include refid="Base_Column_List"/>
        from private_message
        where (sender_id = #{senderId} and receiver_id = #{receiverId})
        or (sender_id = #{receiverId} and receiver_id = #{senderId})
        order by send_time asc
    </select>

    <select id="getUnreadMessages" resultMap="BaseResultMap">
        select <include refid="Base_Column_List"/>
        from private_message
        where receiver_id = #{receiverId} and is_read = false
    </select>

    <update id="markAsRead">
        update private_message
        set is_read = true
        where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <select id="getConversationList" resultMap="BaseResultMap">
        select * from (
        select * from private_message
        where id in (
        select max(id) from private_message
        where sender_id = #{userId} or receiver_id = #{userId}
        group by if(sender_id = #{userId}, receiver_id, sender_id)
        )
        ) as temp
        order by send_time desc
    </select>
</mapper>